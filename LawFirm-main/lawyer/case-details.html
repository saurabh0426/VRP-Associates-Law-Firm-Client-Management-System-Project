<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Details - Lawyer Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c5282;
            --primary-light: #4a69bd;
            --primary-dark: #1a365d;
            --secondary-color: #4299e1;
            --secondary-light: #63b3ed;
            --accent-color: #ebf8ff;
            --success-color: #48bb78;
            --success-light: #c6f6d5;
            --warning-color: #ecc94b;
            --warning-light: #fefcbf;
            --danger-color: #f56565;
            --danger-light: #fed7d7;
            --info-color: #4fc3f7;
            --info-light: #e1f5fe;
            --dark-color: #2d3748;
            --light-color: #f7fafc;
            --gray-100: #f7fafc;
            --gray-200: #edf2f7;
            --gray-300: #e2e8f0;
            --gray-400: #cbd5e0;
            --gray-500: #a0aec0;
            --gray-600: #718096;
            --gray-700: #4a5568;
            --gray-800: #2d3748;
            --gray-900: #1a202c;
            --transition: all 0.3s ease;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            min-height: 100vh;
        }

        /* Enhanced Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: white;
            z-index: 1000;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            overflow-y: auto;
        }

        .sidebar-brand {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .sidebar-brand i {
            font-size: 1.8rem;
            margin-right: 0.8rem;
            color: var(--secondary-color);
            filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.3));
        }

        .sidebar-brand h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 0.8rem 1.5rem;
            margin: 0.4rem 0;
            border-radius: 0.5rem;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }

        .sidebar a.active {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-left: 4px solid var(--secondary-color);
        }

        .sidebar i {
            margin-right: 0.8rem;
            font-size: 1.2rem;
            min-width: 20px;
            text-align: center;
        }

        /* Main content area */
        .main-content {
            margin-left: 250px;
            padding: 2rem;
            transition: var(--transition);
        }

        /* Enhanced Header */
        .header {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header h2 i {
            color: var(--secondary-color);
            font-size: 1.5rem;
        }

        .header p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.95rem;
        }

        .header-actions {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Case details content */
        .content-box {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-header h4 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .content-header h4 i {
            color: var(--primary-color);
        }

        .content-header .actions {
            display: flex;
            gap: 0.5rem;
        }

        .content-body {
            padding: 1.5rem;
        }

        /* Enhanced info block */
        .info-block {
            background-color: var(--gray-50);
            border-radius: 0.8rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--gray-200);
            position: relative;
        }

        .info-item {
            display: flex;
            margin-bottom: 1rem;
            align-items: flex-start;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: var(--gray-700);
            min-width: 150px;
            padding-right: 1rem;
        }

        .info-value {
            color: var(--gray-800);
            flex: 1;
        }

        .info-value.description {
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-200);
            line-height: 1.6;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 500;
            gap: 0.3rem;
        }

        .status-open {
            background-color: var(--info-light);
            color: var(--info-color);
        }

        .status-in-progress {
            background-color: var(--warning-light);
            color: var(--warning-color);
        }

        .status-closed {
            background-color: var(--success-light);
            color: var(--success-color);
        }

        /* Enhanced document upload section */
        .upload-section {
            background-color: white;
            border-radius: 0.8rem;
            padding: 2rem;
            text-align: center;
            border: 2px dashed var(--gray-300);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 2rem;
        }

        .upload-section:hover {
            border-color: var(--secondary-color);
            background-color: var(--accent-color);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .upload-section:hover .upload-icon {
            color: var(--secondary-color);
            transform: translateY(-5px);
        }

        .upload-text {
            font-size: 1.1rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .file-upload {
            margin-bottom: 1.5rem;
        }

        .file-upload input {
            display: none;
        }

        .file-upload label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.95rem;
            box-shadow: var(--shadow);
        }

        .file-upload label:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Enhanced file list */
        .file-list {
            margin-top: 1.5rem;
        }

        .file-list-header {
            background-color: var(--gray-100);
            padding: 1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            border: 1px solid var(--gray-200);
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-list-header i {
            color: var(--primary-color);
        }

        .file-list-empty {
            padding: 2rem;
            text-align: center;
            border: 1px solid var(--gray-200);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            color: var(--gray-500);
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-top: none;
            transition: var(--transition);
            position: relative;
        }

        .file-item:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }

        .file-item:hover {
            background-color: var(--gray-50);
        }

        .file-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
            color: var(--primary-color);
        }

        .file-details {
            flex: 1;
        }

        .file-name-input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border-radius: 0.4rem;
            border: 1px solid var(--gray-300);
            transition: var(--transition);
            font-size: 0.95rem;
        }

        .file-name-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.5rem 1rem;
            border-radius: 0.4rem;
            font-weight: 500;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .btn-edit {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .btn-edit:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-delete {
            background-color: var(--danger-color);
            color: white;
            border: none;
        }

        .btn-delete:hover {
            background-color: #e53e3e;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* OCR Details styling */
        .ocr-details {
            margin-top: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-300);
            overflow: hidden;
        }

        .ocr-details-header {
            padding: 0.8rem 1rem;
            background-color: var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .ocr-details-header:hover {
            background-color: var(--accent-color);
        }

        .ocr-details-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--primary-dark);
        }

        .ocr-details-content {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            display: none;
        }

        .ocr-section {
            margin-bottom: 1rem;
        }

        .ocr-section:last-child {
            margin-bottom: 0;
        }

        .ocr-section-title {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .ocr-section-content {
            background-color: white;
            padding: 0.8rem;
            border-radius: 0.4rem;
            border: 1px solid var(--gray-200);
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        .entity-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.6rem;
            border-radius: 50px;
            font-size: 0.8rem;
            background-color: var(--accent-color);
            color: var(--primary-color);
            margin: 0.2rem;
        }

        /* OCR Modal styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-container {
            background-color: white;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.2rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: var(--transition);
        }

        .modal-close:hover {
            opacity: 1;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-message {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-message-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .modal-message-text {
            font-size: 1.1rem;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .modal-message-subtext {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
        }

        .modal-actions button {
            flex: 1;
            padding: 0.8rem;
            border-radius: 0.4rem;
            font-weight: 500;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background-color: var(--success-color);
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background-color: #38a169;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Responsive styles */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
            }

            .sidebar a {
                padding: 0.8rem;
                justify-content: center;
            }

            .sidebar a i {
                margin-right: 0;
                font-size: 1.3rem;
            }

            .sidebar a span {
                display: none;
            }

            .sidebar-brand {
                padding: 1rem;
                justify-content: center;
            }

            .sidebar-brand h2 {
                display: none;
            }

            .sidebar-brand i {
                margin-right: 0;
            }

            .main-content {
                margin-left: 80px;
            }

            .info-item {
                flex-direction: column;
            }

            .info-label {
                min-width: unset;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1.5rem;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .file-details {
                width: 100%;
            }

            .file-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .modal-container {
                width: 95%;
            }
        }

        @media (max-width: 576px) {
            .header h2 {
                font-size: 1.5rem;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .modal-actions {
                flex-direction: column;
            }
        }

        /* Loading spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Add these CSS styles to your existing stylesheet */

        /* File container to hold both file item and OCR details */
        .file-container {
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        /* Enhanced OCR details styling */
        .ocr-details {
            margin-top: 0.75rem;
            margin-left: 1rem;
            margin-right: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--gray-300);
            overflow: hidden;
            background-color: var(--gray-50);
            box-shadow: var(--shadow-sm);
        }

        .ocr-details-header {
            padding: 0.8rem 1rem;
            background-color: var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--gray-200);
        }

        .ocr-details-header:hover {
            background-color: var(--accent-color);
        }

        .ocr-details-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            color: var(--primary-dark);
        }

        .ocr-details-title i {
            color: var(--primary-color);
        }

        .ocr-details-content {
            padding: 1rem;
            display: none;
        }

        .ocr-section {
            margin-bottom: 1rem;
            background-color: white;
            border-radius: 0.4rem;
            padding: 0.75rem;
            box-shadow: var(--shadow-sm);
        }

        .ocr-section:last-child {
            margin-bottom: 0;
        }

        .ocr-section-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .ocr-section-title::before {
            content: '';
            display: inline-block;
            width: 0.5rem;
            height: 0.5rem;
            background-color: var(--primary-color);
            border-radius: 50%;
        }

        .ocr-section-content {
            background-color: white;
            border-radius: 0.4rem;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        /* Enhanced entity tags */
        .entity-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.6rem;
            border-radius: 50px;
            font-size: 0.8rem;
            background-color: var(--accent-color);
            color: var(--primary-color);
            margin: 0.2rem;
            border: 1px solid var(--secondary-light);
            transition: var(--transition);
        }

        .entity-tag:hover {
            background-color: var(--secondary-light);
            color: white;
            transform: translateY(-1px);
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-gavel"></i>
            <h2>VRP Associates</h2>
        </div>
        <a href="dashboard.html"><i class="fas fa-calendar-alt"></i> <span>Appointments</span></a>
        <a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a>
        <a href="cases.html" class="active"><i class="fas fa-briefcase"></i> <span>Cases</span></a>
        <a href="logout.html"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header Section -->
        <div class="header">
            <div class="header-content">
                <h2><i class="fas fa-folder-open"></i> Case Details</h2>
                <p>View and manage case information and documents</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="back-btn">
                    <i class="fas fa-chevron-left"></i> Back to Cases
                </button>
            </div>
        </div>

        <!-- Case Details Section -->
        <div class="content-box">
            <div class="content-header">
                <h4><i class="fas fa-info-circle"></i> Case Information</h4>
                <div class="actions">
                    <button class="btn btn-edit" id="edit-case-btn">
                        <i class="fas fa-edit"></i> Edit Case
                    </button>
                </div>
            </div>
            <div class="content-body">
                <div class="info-block">
                    <div class="info-item">
                        <div class="info-label">Case Title</div>
                        <div class="info-value" id="case-title">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Client Name</div>
                        <div class="info-value" id="client-name">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Case Area</div>
                        <div class="info-value" id="case-area">Loading...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value">
                            <span class="status-badge status-open" id="case-status">Loading...</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Description</div>
                        <div class="info-value description" id="case-description">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Upload Section -->
        <div class="content-box">
            <div class="content-header">
                <h4><i class="fas fa-file-alt"></i> Case Documents</h4>
            </div>
            <div class="content-body">
                <!-- Upload Section -->
                <div class="upload-section" id="upload-zone">
                    <input type="file" id="file-input" multiple style="display: none;">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Drag & drop files here or click to browse</div>
                    <div class="upload-subtext">Supports PDF, DOC, DOCX, JPG, PNG files up to 10MB</div>
                </div>

                <!-- File List -->
                <div class="file-list">
                    <div class="file-list-header">
                        <i class="fas fa-file-alt"></i> Uploaded Documents
                    </div>
                    <div id="file-list-content">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OCR Confirmation Modal -->
    <div id="ocr-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-robot"></i> OCR Processing
                </div>
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-message">
                    <div class="modal-message-icon">
                        <i class="fas fa-file-search"></i>
                    </div>
                    <div class="modal-message-text">Process this document with OCR?</div>
                    <div class="modal-message-subtext">OCR will extract text, generate a summary, and identify key
                        entities from your document.</div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary ocr-no">
                        <i class="fas fa-file-upload"></i> Upload Only
                    </button>
                    <button class="btn btn-primary ocr-yes">
                        <i class="fas fa-robot"></i> Process with OCR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK and App Config -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCgoPtXj4qy72gq_YEdwfIju2MQaUYbSd0",
            authDomain: "ibase-29eaf.firebaseapp.com",
            projectId: "ibase-29eaf",
            storageBucket: "ibase-29eaf.appspot.com",
            messagingSenderId: "347587111588",
            appId: "1:347587111588:web:4ff899dd7951ab82699431",
            measurementId: "G-XMN0596FV3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Extract case ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const caseId = urlParams.get('caseId');

        // Global variables
        let currentFileForOCR = null;

        // DOM Elements
        const ocrModal = document.getElementById('ocr-modal');
        const modalClose = document.getElementById('modal-close');
        const ocrYesBtn = document.querySelector('.ocr-yes');
        const ocrNoBtn = document.querySelector('.ocr-no');
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const backBtn = document.getElementById('back-btn');

        // Event Listeners
        backBtn.addEventListener('click', () => {
            window.location.href = 'cases.html';
        });

        // Initialize drag and drop functionality
        uploadZone.addEventListener('click', () => {
            fileInput.click();
        });

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            const computedStyle = getComputedStyle(document.documentElement);
            uploadZone.style.backgroundColor = computedStyle.getPropertyValue('--accent-color').trim();
            uploadZone.style.borderColor = computedStyle.getPropertyValue('--secondary-color').trim();
        });

        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadZone.style.backgroundColor = '';
            uploadZone.style.borderColor = '';
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.style.backgroundColor = '';
            uploadZone.style.borderColor = '';

            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });

        // Handle file inputs
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
            }
        });

        // Function to handle selected files
        function handleFiles(files) {
            for (let file of files) {
                // Check file type and size
                const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/png'];
                const maxSize = 10 * 1024 * 1024; // 10MB

                if (!validTypes.includes(file.type)) {
                    showNotification('Invalid file type. Please upload PDF, DOC, DOCX, JPG, or PNG files.', 'error');
                    continue;
                }

                if (file.size > maxSize) {
                    showNotification('File too large. Maximum size is 10MB.', 'error');
                    continue;
                }

                // Prompt for OCR processing
                showOCRModal(file);
            }
        }

        // Function to show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '8px';
            notification.style.backgroundColor = type === 'success' ? '#c6f6d5' : '#fed7d7';
            notification.style.color = type === 'success' ? '#276749' : '#9b2c2c';
            notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
            notification.style.zIndex = '9999';
            notification.style.display = 'flex';
            notification.style.alignItems = 'center';
            notification.style.gap = '10px';
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(20px)';
            notification.style.transition = 'all 0.3s ease';

            // Add icon and text
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;

            // Add to document
            document.body.appendChild(notification);

            // Trigger animation
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);

            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        // OCR Modal Handlers
        function showOCRModal(file) {
            currentFileForOCR = file;
            ocrModal.style.display = 'flex';
        }

        modalClose.addEventListener('click', () => {
            ocrModal.style.display = 'none';
            currentFileForOCR = null;
        });

        // Close modal when clicking outside
        window.onclick = function (event) {
            if (event.target == ocrModal) {
                ocrModal.style.display = 'none';
                currentFileForOCR = null;
            }
        }

        // OCR Yes Button Handler
        ocrYesBtn.addEventListener('click', async () => {
            ocrModal.style.display = 'none';
            if (currentFileForOCR) {
                showNotification('Processing document with OCR...', 'success');
                await uploadAndProcessOCR(currentFileForOCR);
                currentFileForOCR = null;
            }
        });

        // OCR No Button Handler
        ocrNoBtn.addEventListener('click', async () => {
            ocrModal.style.display = 'none';
            if (currentFileForOCR) {
                await uploadFile(currentFileForOCR);
                currentFileForOCR = null;
            }
        });

        // Upload and Process OCR
        async function uploadAndProcessOCR(file) {
            try {
                // Create form data for OCR API
                let formData = new FormData();
                formData.append("file", file);

                // Show loading state for this file
                const fileListContent = document.getElementById('file-list-content');
                const loadingItem = document.createElement('div');
                loadingItem.classList.add('file-item');
                loadingItem.innerHTML = `
                    <div class="file-icon">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="file-details">
                        <strong>Processing ${file.name}</strong>
                        <div>Analyzing document content...</div>
                    </div>
                `;
                fileListContent.appendChild(loadingItem);

                // Call OCR API
                const response = await fetch("http://127.0.0.1:5000/upload", {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('OCR service unavailable');
                }

                const data = await response.json();

                // Upload file to storage
                const fileUrl = await uploadFile(file, true);

                // Prepare OCR details to save in Firestore
                const ocrDetails = {
                    fileName: file.name,
                    originalText: data.original_text || '',
                    correctedText: data.corrected_text || '',
                    summary: data.summary || '',
                    sentiment: data.sentiment || '',
                    entities: data.entities || []
                };

                // Save OCR details to case's ocrDocuments subcollection
                await db.collection("cases").doc(caseId).collection("ocrDocuments").add({
                    ...ocrDetails,
                    fileUrl: fileUrl,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Remove loading item
                fileListContent.removeChild(loadingItem);

                // Update the file list to show new file with OCR details
                await loadFileList();

                showNotification('Document processed successfully with OCR!', 'success');
            } catch (error) {
                console.error("OCR Error:", error);
                showNotification('OCR processing failed. Uploading file without OCR.', 'error');

                // Still upload the file even if OCR fails
                await uploadFile(file);
            }
        }

        // Upload File to Firebase Storage
        async function uploadFile(file, skipDisplayUpdate = false) {
            try {
                // Show loading state if not already shown
                if (!skipDisplayUpdate) {
                    const fileListContent = document.getElementById('file-list-content');
                    const loadingItem = document.createElement('div');
                    loadingItem.classList.add('file-item');
                    loadingItem.innerHTML = `
                <div class="file-icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="file-details">
                    <strong>Uploading ${file.name}</strong>
                    <div>Please wait...</div>
                </div>
            `;
                    fileListContent.appendChild(loadingItem);
                }

                // Create reference to the file location in Firebase Storage
                const fileRef = storage.ref().child(`cases/${caseId}/${file.name}`);

                // Upload file
                await fileRef.put(file);

                // Get the download URL
                const fileUrl = await fileRef.getDownloadURL();

                // Create file metadata WITHOUT the server timestamp
                const fileData = {
                    fileName: file.name,
                    fileUrl: fileUrl,
                    uploadedAt: new Date().toISOString(), // Use string timestamp instead
                    fileType: file.type,
                    fileSize: file.size
                };

                // Add file details to Firestore - using array union for files array
                await db.collection("cases").doc(caseId).update({
                    files: firebase.firestore.FieldValue.arrayUnion(fileData),
                    lastModified: firebase.firestore.FieldValue.serverTimestamp() // Add timestamp separately
                });

                // Update the file list display if not skipped
                if (!skipDisplayUpdate) {
                    await loadFileList();
                    showNotification('File uploaded successfully!', 'success');
                }

                return fileUrl;
            } catch (error) {
                console.error("Error uploading file:", error);
                showNotification('Error uploading file. Please try again.', 'error');

                // Remove loading item and reload list
                if (!skipDisplayUpdate) {
                    await loadFileList();
                }

                throw error;
            }
        }

        // Determine file icon based on file type
        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();

            switch (extension) {
                case 'pdf':
                    return 'fa-file-pdf';
                case 'doc':
                case 'docx':
                    return 'fa-file-word';
                case 'jpg':
                case 'jpeg':
                case 'png':
                    return 'fa-file-image';
                default:
                    return 'fa-file';
            }
        }

        async function renameFile(fileName) {
            const inputElement = document.getElementById(`rename-${fileName.replace(/\./g, '-')}`);
            const newFileName = inputElement.value.trim();

            if (!newFileName) {
                showNotification('Please enter a valid file name.', 'error');
                return;
            }

            // Add the original extension
            const extension = fileName.split('.').pop();
            const fullNewFileName = `${newFileName}.${extension}`;

            try {
                // Show loading state
                inputElement.disabled = true;
                const renameBtn = document.querySelector(`button[onclick="renameFile('${fileName}')"]`);
                renameBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                renameBtn.disabled = true;

                // Instead of trying to download and re-upload the file,
                // we'll just update the metadata in Firestore and 
                // leave the file in Firebase Storage as is

                // Get the file reference to get the current download URL
                const fileRef = storage.ref().child(`cases/${caseId}/${fileName}`);
                const fileUrl = await fileRef.getDownloadURL();

                // Update Firestore case document
                const caseRef = db.collection("cases").doc(caseId);
                const caseDoc = await caseRef.get();
                const files = caseDoc.data().files || [];

                const updatedFiles = files.map(file =>
                    file.fileName === fileName
                        ? {
                            ...file,
                            fileName: fullNewFileName,
                            // Keep the same URL, just updating the name
                            fileUrl: file.fileUrl
                        }
                        : file
                );

                await caseRef.update({ files: updatedFiles });

                // Update OCR document if exists
                const ocrQuery = await db.collection("cases").doc(caseId)
                    .collection("ocrDocuments")
                    .where("fileName", "==", fileName)
                    .get();

                if (!ocrQuery.empty) {
                    const ocrDoc = ocrQuery.docs[0];
                    await ocrDoc.ref.update({
                        fileName: fullNewFileName
                        // Keep the existing fileUrl
                    });
                }

                showNotification('File renamed successfully!', 'success');

                // Reload file list
                await loadFileList();

            } catch (error) {
                console.error("Error renaming file:", error);
                showNotification('Failed to rename file. Please try again.', 'error');

                // Reset input state
                inputElement.disabled = false;
                const renameBtn = document.querySelector(`button[onclick="renameFile('${fileName}')"]`);
                renameBtn.innerHTML = '<i class="fas fa-edit"></i> Rename';
                renameBtn.disabled = false;
            }
        }

        // Delete file
        async function deleteFile(fileName) {
            if (confirm(`Are you sure you want to delete "${fileName}"? This action cannot be undone.`)) {
                try {
                    // Show loading state in file list
                    const fileItem = document.querySelector(`#rename-${fileName.replace(/\./g, '-')}`).closest('.file-item');
                    fileItem.innerHTML = `
                        <div class="file-icon">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div class="file-details">
                            <strong>Deleting ${fileName}</strong>
                            <div>Please wait...</div>
                        </div>
                    `;

                    // Delete from Storage
                    const fileRef = storage.ref().child(`cases/${caseId}/${fileName}`);
                    await fileRef.delete();

                    // Remove from Firestore case files
                    const caseRef = db.collection("cases").doc(caseId);
                    const caseDoc = await caseRef.get();
                    const files = caseDoc.data().files || [];

                    const updatedFiles = files.filter(file => file.fileName !== fileName);

                    await caseRef.update({ files: updatedFiles });

                    // Delete associated OCR documents
                    const ocrQuery = await db.collection("cases").doc(caseId)
                        .collection("ocrDocuments")
                        .where("fileName", "==", fileName)
                        .get();

                    ocrQuery.forEach(async (doc) => {
                        await doc.ref.delete();
                    });

                    showNotification('File deleted successfully!', 'success');

                    // Reload file list
                    await loadFileList();

                } catch (error) {
                    console.error("Error deleting file:", error);
                    showNotification('Failed to delete file. Please try again.', 'error');

                    // Reload file list to reset UI
                    await loadFileList();
                }
            }
        }

        // Toggle OCR details visibility
        function toggleOcrDetails(id) {
            const content = document.getElementById(`ocr-content-${id}`);
            const icon = document.getElementById(`ocr-toggle-icon-${id}`);

            if (content.style.display === 'block') {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        // Fetch and display case details
        async function loadCaseDetails() {
            try {
                const caseDoc = await db.collection("cases").doc(caseId).get();

                if (caseDoc.exists) {
                    const caseData = caseDoc.data();

                    // Update case information
                    document.getElementById("case-title").textContent = caseData.caseTitle || 'Untitled Case';
                    document.getElementById("client-name").textContent = caseData.clientName || 'N/A';
                    document.getElementById("case-area").textContent = caseData.caseArea || 'General';

                    // Update status with appropriate styling
                    const statusElement = document.getElementById("case-status");
                    statusElement.textContent = caseData.status || 'Open';
                    statusElement.className = 'status-badge';

                    // Add appropriate status class
                    if (caseData.status && caseData.status.toLowerCase() === 'open') {
                        statusElement.classList.add('status-open');
                    } else if (caseData.status && caseData.status.toLowerCase() === 'in progress') {
                        statusElement.classList.add('status-in-progress');
                    } else if (caseData.status && caseData.status.toLowerCase() === 'closed') {
                        statusElement.classList.add('status-closed');
                    } else {
                        statusElement.classList.add('status-open');
                    }

                    document.getElementById("case-description").textContent = caseData.caseDescription || 'No description provided.';

                    // Load files
                    await loadFileList();

                } else {
                    showNotification('No case found with this ID.', 'error');
                    setTimeout(() => {
                        window.location.href = 'cases.html';
                    }, 2000);
                }
            } catch (error) {
                console.error("Error loading case details:", error);
                showNotification('Error loading case details. Please try again.', 'error');
            }
        }

        // Load file list
        async function loadFileList() {
            const fileListContent = document.getElementById('file-list-content');
            fileListContent.innerHTML = '<div class="loading-spinner"></div>';

            try {
                // Get case document to access files array
                const caseDoc = await db.collection("cases").doc(caseId).get();
                const caseData = caseDoc.data();
                const files = caseData.files || [];

                // Clear loading spinner
                fileListContent.innerHTML = '';

                if (files.length === 0) {
                    fileListContent.innerHTML = `
                <div class="file-list-empty">
                    <i class="fas fa-file-alt" style="font-size: 2rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                    <p>No documents have been uploaded to this case yet.</p>
                </div>
            `;
                    return;
                }

                // Process each file
                for (const file of files) {
                    const fileName = file.fileName;

                    // Create file item container
                    const fileContainer = document.createElement('div');
                    fileContainer.classList.add('file-container');
                    fileContainer.style.marginBottom = '1.5rem'; // Add space between file containers

                    // Create file item
                    const fileItemElement = document.createElement('div');
                    fileItemElement.classList.add('file-item');

                    // Create file item HTML
                    fileItemElement.innerHTML = `
                <div class="file-icon">
                    <i class="fas ${getFileIcon(fileName)}"></i>
                </div>
                <div class="file-details">
                    <input type="text" class="file-name-input" value="${fileName.split('.')[0]}" id="rename-${fileName.replace(/\./g, '-')}">
                    <small>.${fileName.split('.').pop()}</small>
                </div>
                <div class="file-actions">
                    <button class="btn btn-edit" onclick="renameFile('${fileName}')">
                        <i class="fas fa-edit"></i> Rename
                    </button>
                    <button class="btn btn-delete" onclick="deleteFile('${fileName}')">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            `;

                    // Add file item to container
                    fileContainer.appendChild(fileItemElement);

                    // Check for OCR details
                    try {
                        const ocrQuery = await db.collection("cases").doc(caseId)
                            .collection("ocrDocuments")
                            .where("fileName", "==", fileName)
                            .get();

                        if (!ocrQuery.empty) {
                            const ocrDoc = ocrQuery.docs[0].data();
                            const ocrId = `ocr-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

                            // Create OCR details element
                            const ocrElement = document.createElement('div');
                            ocrElement.classList.add('ocr-details');
                            // Added margin to separate from file item
                            ocrElement.style.marginTop = '0.75rem';
                            ocrElement.style.marginLeft = '1rem';
                            ocrElement.style.marginRight = '1rem';

                            ocrElement.innerHTML = `
                        <div class="ocr-details-header" onclick="toggleOcrDetails('${ocrId}')">
                            <div class="ocr-details-title">
                                <i class="fas fa-robot"></i> OCR Analysis
                            </div>
                            <i class="fas fa-chevron-down" id="ocr-toggle-icon-${ocrId}"></i>
                        </div>
                        <div class="ocr-details-content" id="ocr-content-${ocrId}" style="display: none;">
                            <div class="ocr-section">
                                <div class="ocr-section-title">Summary</div>
                                <div class="ocr-section-content">${ocrDoc.summary || 'No summary available.'}</div>
                            </div>
                            
                            <div class="ocr-section">
                                <div class="ocr-section-title">Sentiment</div>
                                <div class="ocr-section-content">${ocrDoc.sentiment || 'No sentiment analysis available.'}</div>
                            </div>
                            
                            <div class="ocr-section">
                                <div class="ocr-section-title">Entities</div>
                                <div class="ocr-section-content">
                                    ${ocrDoc.entities && ocrDoc.entities.length > 0
                                    ? ocrDoc.entities.map(e => `<span class="entity-tag">${e.text} (${e.label})</span>`).join(' ')
                                    : 'No entities detected.'}
                                </div>
                            </div>
                            
                            <div class="ocr-section">
                                <div class="ocr-section-title">Extracted Text</div>
                                <div class="ocr-section-content">${ocrDoc.correctedText || ocrDoc.originalText || 'No text extracted.'}</div>
                            </div>
                        </div>
                    `;

                            // Add OCR element to container (after the file item)
                            fileContainer.appendChild(ocrElement);
                        }
                    } catch (error) {
                        console.error("Error fetching OCR details:", error);
                    }

                    // Add the complete file container to the file list
                    fileListContent.appendChild(fileContainer);
                }

            } catch (error) {
                console.error("Error loading file list:", error);
                fileListContent.innerHTML = `
            <div class="file-list-empty">
                <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: var(--danger-color); margin-bottom: 1rem;"></i>
                <p>Error loading documents. Please try again.</p>
            </div>
        `;
            }
        }

        // Make functions globally available
        window.renameFile = renameFile;
        window.deleteFile = deleteFile;
        window.toggleOcrDetails = toggleOcrDetails;

        // Load case details when page loads
        document.addEventListener('DOMContentLoaded', loadCaseDetails);
    </script>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
</body>

</html>